# LINE Bot 測試指南

本指南將幫助您在本地環境中測試LINE Bot的對話功能。

## 準備工作

1. 確保您已經在[LINE Developers Console](https://developers.line.biz/)創建了一個Channel
2. 獲取Channel Access Token和Channel Secret
3. 在`.env`文件中設置這些憑證
4. **重要**: 確保您已經通過Streamlit界面上傳了文檔並更新了知識庫

## 步驟1：安裝ngrok

由於LINE需要通過公網URL訪問您的Webhook，我們需要使用ngrok等工具將本地服務器暴露到互聯網。

1. 下載並安裝[ngrok](https://ngrok.com/download)
2. 註冊一個ngrok帳號並獲取authtoken
3. 設置authtoken：
   ```
   ngrok config add-authtoken 您的authtoken
   ```

## 步驟2：啟動LINE Bot服務器

使用以下命令啟動LINE Bot服務器：

```bash
./run_line_bot_v3.sh
```

或者：

```bash
python -m line_bot.line_bot_v3
```

服務器將在本地的8000端口（或您在.env中設置的LINE_BOT_PORT）啟動。

## 步驟3：使用ngrok創建公網URL

打開一個新的終端窗口，運行以下命令：

```bash
ngrok http 8000
```

ngrok將顯示一個類似以下的輸出：

```
Session Status                online
Account                       您的帳號
Version                       3.5.0
Region                        Asia Pacific (ap)
Latency                       24ms
Web Interface                 http://127.0.0.1:4040
Forwarding                    https://xxxx-xxx-xxx-xxx.ap.ngrok.io -> http://localhost:8000
```

記下`Forwarding`後面的https URL（例如`https://xxxx-xxx-xxx-xxx.ap.ngrok.io`）。

## 步驟4：設置LINE Webhook URL

1. 登錄[LINE Developers Console](https://developers.line.biz/)
2. 選擇您的Provider和Channel
3. 進入"Messaging API"設置
4. 在"Webhook settings"部分：
   - 設置Webhook URL為：`https://xxxx-xxx-xxx-xxx.ap.ngrok.io/callback`（使用您的ngrok URL）
   - 開啟"Use webhook"選項
   - 點擊"Verify"按鈕測試連接

## 步驟5：測試智能問答功能

現在您可以使用LINE應用程序與您的機器人對話：

1. 在LINE Developers Console的"Messaging API"頁面找到QR碼
2. 使用LINE應用程序掃描QR碼添加機器人為好友
3. 向機器人發送財務稅法相關問題，例如：
   - "什麼是營業稅？"
   - "如何申報個人所得稅？"
   - "公司設立需要哪些文件？"

機器人將使用智能問答功能回答您的問題，並提供參考來源。

## 智能問答功能說明

LINE Bot現在具有與Streamlit服務相同的智能問答功能：

1. **基於知識庫的回答**：機器人會從您上傳的文檔中檢索相關信息來回答問題
2. **參考來源引用**：回答中會包含參考來源，幫助您了解信息來自哪裡
3. **上下文理解**：機器人能夠理解對話上下文，進行連續對話
4. **自定義設置**：您可以自定義模型參數

### 自定義設置命令

您可以使用以下命令自定義機器人的行為：

```
/設置 參數=值
```

或英文版本：

```
/setting 參數=值
```

支持的參數包括：

- `model`：OpenAI模型（可選值：gpt-3.5-turbo-16k, gpt-4o, gpt-4-turbo, gpt-4-mini）
- `temperature`：創造性參數（0-1之間的數值，越高越創造性）
- `top_k_sources`：顯示的參考來源數量（1-10之間的整數）
- `similarity_threshold`：參考來源相似度閾值（0-1之間的數值）

例如：

```
/設置 model=gpt-4o temperature=0.8 top_k_sources=5
```

設置會保存在您的用戶會話中，後續對話將使用這些設置。

## 故障排除

如果機器人沒有回應，請檢查：

1. LINE Bot服務器是否正在運行
2. MCP服務器是否正在運行（應在8001端口）
3. ngrok是否正常工作（查看http://127.0.0.1:4040）
4. Webhook URL是否正確設置
5. 查看LINE Bot服務器的日誌輸出，尋找錯誤信息

常見問題：

- **Webhook驗證失敗**：確保URL正確，並且包含`/callback`路徑
- **簽名驗證錯誤**：確保Channel Secret正確設置
- **連接超時**：確保MCP服務器正在運行
- **智能問答功能不工作**：確保您已經通過Streamlit界面上傳了文檔並更新了知識庫

## 使用LINE Official Account Manager

您還可以通過[LINE Official Account Manager](https://manager.line.biz/)管理您的機器人：

1. 使用與開發者帳號相同的LINE帳號登錄
2. 選擇您的機器人帳號
3. 您可以在這裡：
   - 查看用戶統計信息
   - 設置自動回覆消息
   - 發送廣播消息
   - 管理其他設置

## 注意事項

- ngrok的免費版本每次啟動會生成不同的URL，需要重新設置Webhook URL
- 每次重啟ngrok後，都需要更新LINE Developers Console中的Webhook URL
- 確保MCP服務器在測試前已經啟動，因為LINE Bot依賴它來處理問答
- 確保您已經通過Streamlit界面上傳了文檔並更新了知識庫，否則智能問答功能將無法正常工作